# CSK-Tests

This is a private repository of JUnit tests that were automatically produced from an original set of tests for [VDMTools](https://github.com/vdmtools/vdmtools), created by CSK Corp in Japan.

The CSK tests were converted to apply to the VDMJ tool in 2008 using JUnit 3. The suite was subsequently converted to a Maven project in 2025. The tests pass on the latest version of VDMJ (currently 4.7.0-SNAPSHOT). The test suite can be executed with "mvn clean test" at the top level.

The main test class is called `CSKTest`, which has `processXX` methods to run tests in the XX dialect. These methods load a VDM source file from Java resources and call a common `process` method to parse/check/execute the source, checking the result against the processXX arguments and expected result resource files.

There are up to four resource files related to each test:

1. `<name>.assert`

    This file contains the expected VDMTools error numbers that the test will produce (eg. syntax or typechecker errors), or the function or operation call to make and its expected result. The syntax of the file is valid VDM-SL, eg. `[12, 322]` or `Test() = {1,2,3}`.

2. `<name>.vdm` or `<name>.vpp`

    These files contain the VDM-SL, VDM++ or VICE (ie. VDM-RT) source for the test.

3. `<name>.vdmj`

    These files contain the expected error numbers for VDMJ; these are very similar to `<name>.assert` files, except with VDMJ numbers. In addition, the files contain the full text output of the parse/check error messages found, which should match the numbers at the top.

4. `<name>.pog`

    For POG tests, these files contain the POs generated by the test specification, for comparisons.

The resources and corresponding tests fall into four main groups: csksltest, cskpptest, cskrttest, cskthreads.

Within each group, there are up to three subgroups:

- "cgip" tests relate to the code generator and interpreter. So the `*.assert` files here define how to invoke the test and what to expect as a result.

- "pog" tests relate to the proof obligation generator. The `*.assert` files here contain the POs in an internal form defined by VDMTools. The corresponding JUnit tests generate VDMJ POs and compare the result with `*.pog` files.

- "tc" tests relate to the type checker. The `*.assert` files contain a list of expected VDMTools error numbers and the `*.vdmj` files contain the VDMJ equivalents, along with expanded error messages and locations.

Each subgroup has sub-structure folders within it, like src/test/resources/csksltest/cgip/SL/expr/recordexpr/recordexpr-01.assert.

Each JUnit call to `processXX` passes an `AssertType` to define how to perform the test and what to check against. The values are:

- `TRUE`

    The spec should be error free and the evaluation in `*.assert` should be true (eg. Test() = 123)

- `VOID`

    The spec should be error free and the evaluation in `*.assert` should return no value (eg. Test())

- `UNDEFINED`

    The spec should be error free and the evaluation in `*.assert` should return an `undefined` value.

- `ERRLIST`

    The spec should have syntax or TC errors, which should match the `*.vdmj` file.

- `POG`

    The spec should be error free and the POG should generate POs that match the `*.pog` file.

- `SKIP`

    The test should be skipped. This is used for the few cases where tests are very specific to the behaviour of VDMTools (eg. regarding thread scheduling policies, that are not identical in VDMJ).

A boolean constant in `CSKTest` called `REBUILD_EXPECTED_RESULTS` will overwrite any `<name>.vdmj` or `<name>.pog` file with the result of running a test under VDMJ. This can be useful when VDMJ is changed, to keep the expected results up to date. If you forget to set the constant back to `false`, a test at the top level called `test_rebuild_flag` will fail.
